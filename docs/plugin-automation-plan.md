# Flutter-like Plugin Automation System Implementation Plan

## Overview
Implement an automatic plugin integration system similar to Flutter's federated plugin model. When users run `gyo install`, the system will:
1. Discover plugins from `package.json`
2. Cache native code locally in `.gyo/` directory
3. Auto-generate platform configuration files (settings.gradle, Package.swift)
4. Support local plugin development workflow

## Architecture Design

### 1. File Structure

```
project-root/
‚îú‚îÄ‚îÄ .gyo/
‚îÇ   ‚îú‚îÄ‚îÄ plugins.json              # Plugin manifest (Flutter's .flutter-plugins equivalent)
‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ plugins/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ @gyo/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ webview/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ android/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ios/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ camera/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ android/
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ios/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ custom-plugin/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ android/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ ios/
‚îú‚îÄ‚îÄ android/
‚îÇ   ‚îú‚îÄ‚îÄ settings.gradle           # Auto-generated section for plugin includes
‚îÇ   ‚îî‚îÄ‚îÄ app/build.gradle
‚îú‚îÄ‚îÄ ios/
‚îÇ   ‚îî‚îÄ‚îÄ Package.swift             # Auto-generated SPM dependencies
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ package.json              # Plugin metadata in "gyo" field
‚îî‚îÄ‚îÄ gyo.config.json
```

### 2. Plugin Manifest Format (`.gyo/plugins.json`)

```json
{
  "plugins": {
    "@gyo/webview": {
      "version": "1.0.0",
      "source": "npm",
      "platforms": {
        "android": {
          "path": ".gyo/cache/plugins/@gyo/webview/android",
          "moduleName": "gyo_webview"
        },
        "ios": {
          "path": ".gyo/cache/plugins/@gyo/webview/ios",
          "packageName": "GyoWebview"
        }
      }
    }
  },
  "generatedDate": "2026-01-05T...",
  "gyoVersion": "0.1.0"
}
```

### 3. Package Metadata Format (lib/package.json)

```json
{
  "name": "my-app",
  "dependencies": {
    "@gyo/webview": "^1.0.0"
  },
  "gyo": {
    "plugins": [
      "@gyo/webview",
      "@gyo/camera"
    ]
  }
}
```

Plugin packages will include metadata in their package.json:

```json
{
  "name": "@gyo/webview",
  "version": "1.0.0",
  "gyo": {
    "plugin": true,
    "platforms": {
      "android": {
        "moduleName": "gyo_webview",
        "sourceDir": "android"
      },
      "ios": {
        "packageName": "GyoWebview",
        "sourceDir": "ios"
      }
    }
  }
}
```

### 4. Auto-Generated Android Configuration

**templates/android/settings.gradle** (updated):
```gradle
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "{{PROJECT_NAME}}"
include ':app'

// BEGIN GYO PLUGINS - DO NOT EDIT
// This section is automatically generated by `gyo install`
// END GYO PLUGINS
```

After `gyo install`, it becomes:
```gradle
// BEGIN GYO PLUGINS - DO NOT EDIT
// This section is automatically generated by `gyo install`
include ':gyo_webview'
project(':gyo_webview').projectDir = new File(rootProject.projectDir, '../.gyo/cache/plugins/@gyo/webview/android')

include ':gyo_camera'
project(':gyo_camera').projectDir = new File(rootProject.projectDir, '../.gyo/cache/plugins/@gyo/camera/android')
// END GYO PLUGINS
```

**templates/android/app/build.gradle** (updated):
```gradle
dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    // ... other dependencies

    // BEGIN GYO PLUGINS - DO NOT EDIT
    // This section is automatically generated by `gyo install`
    // END GYO PLUGINS
}
```

After `gyo install`:
```gradle
    // BEGIN GYO PLUGINS - DO NOT EDIT
    // This section is automatically generated by `gyo install`
    implementation project(':gyo_webview')
    implementation project(':gyo_camera')
    // END GYO PLUGINS
```

### 5. Auto-Generated iOS Configuration (SPM)

**templates/ios/Package.swift** (new file):
```swift
// swift-tools-version: 5.9
import PackageDescription

let package = Package(
    name: "{{PROJECT_NAME}}",
    platforms: [
        .iOS(.v13)
    ],
    products: [
        .library(
            name: "{{PROJECT_NAME}}",
            targets: ["{{PROJECT_NAME}}"])
    ],
    dependencies: [
        // BEGIN GYO PLUGINS - DO NOT EDIT
        // This section is automatically generated by `gyo install`
        // END GYO PLUGINS
    ],
    targets: [
        .target(
            name: "{{PROJECT_NAME}}",
            dependencies: [
                // BEGIN GYO PLUGINS - DO NOT EDIT
                // This section is automatically generated by `gyo install`
                // END GYO PLUGINS
            ]
        )
    ]
)
```

After `gyo install`:
```swift
    dependencies: [
        // BEGIN GYO PLUGINS - DO NOT EDIT
        // This section is automatically generated by `gyo install`
        .package(path: "../.gyo/cache/plugins/@gyo/webview/ios"),
        .package(path: "../.gyo/cache/plugins/@gyo/camera/ios"),
        // END GYO PLUGINS
    ],
    targets: [
        .target(
            name: "{{PROJECT_NAME}}",
            dependencies: [
                // BEGIN GYO PLUGINS - DO NOT EDIT
                // This section is automatically generated by `gyo install`
                .product(name: "GyoWebview", package: "webview"),
                .product(name: "GyoCamera", package: "camera"),
                // END GYO PLUGINS
            ]
        )
    ]
```

## Implementation Plan (MVP Phase)

### Phase 1: Core Infrastructure (Android Only)

#### 1.1 Create Plugin Manager (`cli/src/utils/plugin-manager.ts`)

**Purpose**: Core service for plugin discovery, caching, and manifest management

**Key Functions**:
```typescript
interface PluginMetadata {
  name: string;
  version: string;
  source: 'npm' | 'local';
  platforms: {
    android?: {
      moduleName: string;
      sourceDir: string;
    };
    ios?: {
      packageName: string;
      sourceDir: string;
    };
  };
}

interface PluginManifest {
  plugins: Record<string, {
    version: string;
    source: string;
    platforms: Record<string, any>;
  }>;
  generatedDate: string;
  gyoVersion: string;
}

class PluginManager {
  // Discover plugins from lib/package.json
  async discoverPlugins(): Promise<PluginMetadata[]>

  // Read plugin metadata from node_modules
  async readPluginMetadata(packageName: string): Promise<PluginMetadata>

  // Copy plugin native code to .gyo/cache/plugins/
  async cachePlugin(plugin: PluginMetadata): Promise<void>

  // Generate/update .gyo/plugins.json manifest
  async updateManifest(plugins: PluginMetadata[]): Promise<void>

  // Read current manifest
  async readManifest(): Promise<PluginManifest | null>
}
```

**Implementation Details**:
- Use `fs-extra` for file operations
- Parse `lib/node_modules/[package]/package.json` for plugin metadata
- Validate plugin structure (check for android/ios directories)
- Handle version conflicts and updates

#### 1.2 Create Android Integration Service (`cli/src/utils/android-plugin-integrator.ts`)

**Purpose**: Auto-generate Android configuration files

**Key Functions**:
```typescript
class AndroidPluginIntegrator {
  // Update android/settings.gradle with plugin includes
  async updateSettingsGradle(plugins: PluginMetadata[]): Promise<void>

  // Update android/app/build.gradle with plugin dependencies
  async updateAppBuildGradle(plugins: PluginMetadata[]): Promise<void>

  // Helper: Find and replace auto-generated section
  private replaceGeneratedSection(
    content: string,
    beginMarker: string,
    endMarker: string,
    newContent: string
  ): string
}
```

**Implementation Details**:
- Use regex to find `// BEGIN GYO PLUGINS` and `// END GYO PLUGINS` markers
- Generate gradle include statements:
  ```gradle
  include ':plugin_module_name'
  project(':plugin_module_name').projectDir = new File(rootProject.projectDir, 'relative/path')
  ```
- Generate dependency statements:
  ```gradle
  implementation project(':plugin_module_name')
  ```
- Preserve existing file content outside markers

#### 1.3 Create Install Command (`cli/src/commands/install.ts`)

**Purpose**: Main entry point for `gyo install` command

**Implementation**:
```typescript
export class InstallCommand {
  async execute(): Promise<void> {
    logger.info('üîç Discovering plugins...');

    const pluginManager = new PluginManager();
    const plugins = await pluginManager.discoverPlugins();

    if (plugins.length === 0) {
      logger.info('No plugins found in package.json');
      return;
    }

    logger.info(`Found ${plugins.length} plugin(s): ${plugins.map(p => p.name).join(', ')}`);

    // Cache plugins
    logger.info('üì¶ Caching plugin native code...');
    for (const plugin of plugins) {
      await pluginManager.cachePlugin(plugin);
      logger.success(`  ‚úì Cached ${plugin.name}`);
    }

    // Update manifest
    await pluginManager.updateManifest(plugins);

    // Integrate with Android (MVP)
    const androidPlugins = plugins.filter(p => p.platforms.android);
    if (androidPlugins.length > 0) {
      logger.info('ü§ñ Updating Android configuration...');
      const androidIntegrator = new AndroidPluginIntegrator();
      await androidIntegrator.updateSettingsGradle(androidPlugins);
      await androidIntegrator.updateAppBuildGradle(androidPlugins);
      logger.success('  ‚úì Android configuration updated');
    }

    logger.success('‚ú® Plugin installation complete!');
    logger.info('\nNext steps:');
    logger.info('  ‚Ä¢ Run: gyo build android');
    logger.info('  ‚Ä¢ Or: gyo run android');
  }
}
```

#### 1.4 Update Project Templates

**Files to modify**:
1. `templates/android/settings.gradle` - Add GYO PLUGINS markers
2. `templates/android/app/build.gradle` - Add GYO PLUGINS markers
3. `templates/ios/Package.swift` - Create new file with markers (for future)

**Changes**:
- Add `// BEGIN GYO PLUGINS - DO NOT EDIT` and `// END GYO PLUGINS` comments
- Ensure templates work both before and after plugin installation

#### 1.5 Update CLI Entry Point

**File**: `cli/src/index.ts`

**Changes**:
```typescript
import { InstallCommand } from './commands/install.ts';

// In command router
case 'install':
  await new InstallCommand().execute();
  break;
```

### Phase 2: Local Plugin Development Support

#### 2.1 Support Local Plugin References

**Enhancement to `PluginManager.discoverPlugins()`**:
- Check for `file:` protocol in package.json dependencies
- Example: `"@gyo/my-plugin": "file:../../gyo-plugins/my-plugin"`
- For local plugins, use direct path instead of caching to `.gyo/`

**Implementation**:
```typescript
async cachePlugin(plugin: PluginMetadata): Promise<void> {
  if (plugin.source === 'local') {
    // Don't copy, just reference original path
    return;
  }

  // For npm plugins, copy to .gyo/cache/
  const sourcePath = path.join('lib', 'node_modules', plugin.name);
  const cachePath = path.join('.gyo', 'cache', 'plugins', plugin.name);
  await fs.copy(sourcePath, cachePath);
}
```

#### 2.2 Update Android Integrator for Local Plugins

**Enhancement to `updateSettingsGradle()`**:
```typescript
for (const plugin of plugins) {
  const pluginPath = plugin.source === 'local'
    ? plugin.platforms.android.localPath  // Use original path
    : `../.gyo/cache/plugins/${plugin.name}/android`;  // Use cache

  gradleContent += `include ':${moduleName}'\n`;
  gradleContent += `project(':${moduleName}').projectDir = new File(rootProject.projectDir, '${pluginPath}')\n\n`;
}
```

### Phase 3: iOS Integration (Future)

#### 3.1 Create iOS Integration Service (`cli/src/utils/ios-plugin-integrator.ts`)

**Key Functions**:
```typescript
class IosPluginIntegrator {
  async updatePackageSwift(plugins: PluginMetadata[]): Promise<void>

  private generateDependencies(plugins: PluginMetadata[]): string
  private generateTargetDependencies(plugins: PluginMetadata[]): string
}
```

#### 3.2 Enhance Install Command

Add iOS integration to `InstallCommand.execute()`:
```typescript
const iosPlugins = plugins.filter(p => p.platforms.ios);
if (iosPlugins.length > 0) {
  logger.info('üçé Updating iOS configuration...');
  const iosIntegrator = new IosPluginIntegrator();
  await iosIntegrator.updatePackageSwift(iosPlugins);
  logger.success('  ‚úì iOS configuration updated');
}
```

### Phase 4: Advanced Features (Future)

1. **Auto-sync on Build**: Run `gyo install` automatically before build if package.json changed
2. **Plugin Version Management**: Handle version updates, conflicts, and rollbacks
3. **Cache Cleanup**: Remove unused cached plugins
4. **Validation**: Verify plugin structure and compatibility
5. **Error Recovery**: Handle missing plugins, corrupted cache, etc.

## Files to Create/Modify

### New Files
- `cli/src/commands/install.ts` - Main install command
- `cli/src/utils/plugin-manager.ts` - Core plugin management service
- `cli/src/utils/android-plugin-integrator.ts` - Android configuration generator
- `templates/ios/Package.swift` - iOS SPM template (future)

### Modified Files
- `cli/src/index.ts` - Add install command routing
- `templates/android/settings.gradle` - Add auto-generation markers
- `templates/android/app/build.gradle` - Add auto-generation markers

## Testing Strategy

### Unit Tests
- Test `PluginManager.discoverPlugins()` with various package.json configurations
- Test `AndroidPluginIntegrator.replaceGeneratedSection()` with edge cases
- Test cache management (create, update, read manifest)

### Integration Tests
1. Create test project with test plugins
2. Run `gyo install`
3. Verify `.gyo/plugins.json` is generated correctly
4. Verify `android/settings.gradle` is updated correctly
5. Verify `android/app/build.gradle` is updated correctly
6. Run `gyo build android` and verify successful build

### Manual Testing
1. Create real plugin package with android/ directory
2. Add to test app's package.json
3. Run `npm install` in lib/
4. Run `gyo install`
5. Verify Android Studio can open project and build succeeds

## Success Criteria (MVP)

- [ ] `gyo install` command successfully discovers plugins from package.json
- [ ] Plugin native code is cached to `.gyo/cache/plugins/`
- [ ] `.gyo/plugins.json` manifest is generated correctly
- [ ] `android/settings.gradle` is auto-updated with plugin includes
- [ ] `android/app/build.gradle` is auto-updated with plugin dependencies
- [ ] Android build succeeds with installed plugins
- [ ] Auto-generated sections are clearly marked and preserved on re-run
- [ ] Local plugin development is supported (file: protocol)

## Notes

- MVP focuses on Android only to validate the architecture
- iOS integration follows same pattern but with SPM syntax
- System is designed to be idempotent (can run `gyo install` multiple times safely)
- Follows Flutter's approach: source code distribution, compile during app build
- Clear separation between user-editable and auto-generated sections in config files
